{% extends "base.html" %}

{% block title %}{{ title }} - Face Recognition System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="display-5 mb-3">
                <i class="bi bi-gear text-primary me-2"></i>
                Управление обучением
            </h1>
            <p class="lead text-muted">
                Статистика системы и управление данными для обучения
            </p>
        </div>

        {% if error %}
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>{{ error }}
        </div>
        {% endif %}

        <!-- System Stats -->
        <div class="row g-4 mb-5">
            <div class="col-lg-3 col-md-6">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-people display-4 mb-3"></i>
                        <h2 class="mb-1">{{ stats.total_persons if stats else 0 }}</h2>
                        <p class="mb-0">Всего людей</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-images display-4 mb-3"></i>
                        <h2 class="mb-1">{{ stats.active_photos if stats else 0 }}</h2>
                        <p class="mb-0">Активных фото</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-person-check display-4 mb-3"></i>
                        <h2 class="mb-1">{{ stats.persons_with_photos if stats else 0 }}</h2>
                        <p class="mb-0">Людей с фото</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up display-4 mb-3"></i>
                        <h2 class="mb-1">{{ "%.1f"|format(stats.avg_confidence * 100 if stats else 0) }}%</h2>
                        <p class="mb-0">Средняя точность</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-activity me-2"></i>Состояние системы</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Статус сервисов</h6>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-success me-2">●</span>
                            Распознавание лиц
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-success me-2">●</span>
                            База данных
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-success me-2">●</span>
                            Файловая система
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Настройки</h6>
                        <p class="mb-1"><strong>Порог распознавания:</strong> 60%</p>
                        <p class="mb-1"><strong>Макс. размер файла:</strong> 10 MB</p>
                        <p class="mb-1"><strong>Форматы:</strong> JPG, JPEG, PNG</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-outline-primary" onclick="checkHealth()">
                        <i class="bi bi-arrow-clockwise me-2"></i>Проверить состояние
                    </button>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Последние загрузки</h5>
            </div>
            <div class="card-body">
                {% if recent_photos %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Файл</th>
                                <th>Человек</th>
                                <th>Точность</th>
                                <th>Дата</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for photo in recent_photos %}
                            <tr>
                                <td>
                                    <i class="bi bi-image me-2"></i>
                                    {{ photo.filename }}
                                </td>
                                <td>{{ photo.person_name }}</td>
                                <td>
                                    <span class="badge bg-{% if photo.confidence > 0.8 %}success{% elif photo.confidence > 0.6 %}warning{% else %}danger{% endif %}">
                                        {{ "%.1f"|format(photo.confidence * 100) }}%
                                    </span>
                                </td>
                                <td>{{ photo.created_at }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger"
                                            onclick="deletePhoto({{ photo.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-clock-history display-4 text-muted mb-3"></i>
                    <p class="text-muted">Нет недавних загрузок</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Быстрые действия</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-grid">
                            <a href="/upload" class="btn btn-primary">
                                <i class="bi bi-upload me-2"></i>
                                Загрузить новые фото
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-grid">
                            <a href="/persons" class="btn btn-info">
                                <i class="bi bi-people me-2"></i>
                                Управление людьми
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-grid">
                            <a href="/identify" class="btn btn-success">
                                <i class="bi bi-search me-2"></i>
                                Тестировать распознавание
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-grid">
                            <button class="btn btn-warning" onclick="exportData()">
                                <i class="bi bi-download me-2"></i>
                                Экспорт данных
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Recommendations -->
        {% if stats and stats.avg_confidence < 0.7 %}
        <div class="alert alert-warning mt-4" role="alert">
            <h6 class="alert-heading">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Рекомендации по улучшению качества
            </h6>
            <p class="mb-0">
                Средняя точность распознавания ниже рекомендуемого уровня (70%).
                Рекомендуется добавить больше качественных фотографий или удалить изображения низкого качества.
            </p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function checkHealth() {
   try {
       const response = await fetch('/api/health');
       const result = await response.json();

       if (response.ok) {
           alert('✅ Все сервисы работают нормально');
       } else {
           alert('❌ Обнаружены проблемы: ' + result.error);
       }
   } catch (error) {
       alert('❌ Ошибка проверки: ' + error.message);
   }
}

async function deletePhoto(photoId) {
   if (!confirm('Вы уверены, что хотите удалить эту фотографию?')) {
       return;
   }

   try {
       const response = await fetch(`/api/photos/${photoId}`, {
           method: 'DELETE'
       });

       if (response.ok) {
           location.reload();
       } else {
           const result = await response.json();
           alert('Ошибка: ' + (result.detail?.error || 'Не удалось удалить'));
       }
   } catch (error) {
       alert('Ошибка: ' + error.message);
   }
}

async function exportData() {
   try {
       const response = await fetch('/api/stats');
       const result = await response.json();

       if (response.ok) {
           const dataStr = JSON.stringify(result, null, 2);
           const dataBlob = new Blob([dataStr], {type: 'application/json'});

           const link = document.createElement('a');
           link.href = URL.createObjectURL(dataBlob);
           link.download = `face_recognition_stats_${new Date().toISOString().split('T')[0]}.json`;
           link.click();
       } else {
           alert('Ошибка экспорта данных');
       }
   } catch (error) {
       alert('Ошибка: ' + error.message);
   }
}
</script>
{% endblock %}